<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd">
    <changeSet author="Punam Mankar" id="1661717533937-1">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="academy_awards"/>
            </not>
        </preConditions>
        <createTable tableName="academy_awards">
            <column name="academy_id" type="BIGINT" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="win_year" type="CLOB(1048576)"/>
            <column name="category" type="CLOB(1048576)"/>
            <column name="nominee" type="CLOB(1048576)"/>
            <column name="additional_info" type="CLOB(1048576)"/>
            <column name="won" type="CLOB(1048576)"></column>
        </createTable>
    </changeSet>
    <changeSet author="Punam Mankar" id="1661717533937-2">
        <createTable tableName="movie">
            <column name="movie_id" type="BIGINT" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="movie_name" type="CLOB(1048576)"/>
          <!--  <column name="rating" type="BIGINT"/>
            <column name="count" type="numeric"/>-->
        </createTable>
    </changeSet>
    <changeSet author="Punam Mankar" id="1661717533937-3">
        <createTable tableName="rating">
            <column name="rating_id" type="BIGINT" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="rating" type="BIGINT"/>
            <column name="movie_id" type="BIGINT"/>
        </createTable>
    </changeSet>

     <changeSet author="Punam Mankar" id="1661717533937-3.2">
         <addNotNullConstraint columnName="rating" defaultNullValue="0" columnDataType="BIGINT" tableName="rating"/>
     </changeSet>

    <changeSet author="punam (generated)" id="1661717533937-14">
        <addForeignKeyConstraint baseColumnNames="movie_id" baseTableName="rating" constraintName="FKcsmt91lxhsicbupowmkll1854" deferrable="false" initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="movie_id" referencedTableName="movie" validate="true"/>
    </changeSet>

    <changeSet author="Punam Mankar" id="1661717533937-4">
        <loadData tableName="academy_awards"
                  file="academy_awards.csv"
                  quotchar='"'
                  encoding="UTF-8"
                  usePreparedStatements="true">
            <column header="win_year" name="win_year" type="CLOB(8000)"/>
            <column header="category" name="category" type="CLOB(8000)"/>
            <column header="nominee" name="nominee" type="CLOB(8000)"/>
            <column header="additional_info" name="additional_info" type="CLOB(8000)"/>
            <column header="won" name="won" type="CLOB(8000)"/>
        </loadData>
    </changeSet>
    <changeSet author="Punam Mankar" id="1661717533937-5">
        <sql>insert into movie (movie_name)
             select DISTINCT(nominee)
             from academy_awards
             where category like 'Best Picture'
               AND won = 'YES';</sql>
    </changeSet>
</databaseChangeLog>
